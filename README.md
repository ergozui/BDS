# 区块链存证溯源系统
本系统用来将文件系统中存储的重要文件的哈希值上链存储，系统用户均可以使用该系统用文件名索引查询到文件的哈希值，再将该哈希值与本地的哈希结果进行比对，从而确定文件的真伪。

测试用的sol代码如下，需要提前在测试链上跑起来，笔者用的geth开发的也可以考虑用现成的测试链比如Ganache。
``` 
// SPDX-License-Identifier: GPL-3.0
pragma solidity ^0.4.23;
pragma experimental ABIEncoderV2;
contract Evidence {
    struct FileEvidence {
        string fileHash;
        string author;
        string time;
        string fileName;
    }

    uint private CODE_SUCCESS = 0;
    mapping(string => FileEvidence) private filemap;
    string[] private fileList;
    event UpdateInfo(string fileHash, string author, string fileName, string time);
    event DeleteInfo(string fileName);

    function saveEvidence(string memory fileName, string memory author, string memory fileHash, string memory time) public returns (uint code) {
        FileEvidence storage fileEvidence = filemap[fileName];
        fileEvidence.fileHash = fileHash;
        fileEvidence.author = author;
        fileEvidence.time = time;
        fileEvidence.fileName = fileName;
        fileList.push(fileName);
        emit UpdateInfo(fileHash, author, fileName, time);
        return CODE_SUCCESS;
    }

    function getEvidence(string memory fileName) public view returns (string memory) {
        FileEvidence storage fileEvidence = filemap[fileName];
        return fileEvidence.fileHash;
    }

    function deleteEvidence(string memory fileName) public  returns (uint code) {
        require(bytes(fileName).length > 0, "File name cannot be empty");

        delete filemap[fileName];

        emit DeleteInfo(fileName);
        return CODE_SUCCESS;
    }
}
``` 
##以太坊终端操作
1. 启动geth控制台
``` 
geth --datadir dir --networkid 15 console 2>logdata.log
```
2. abi
``` 
abi=[{"constant":false,"inputs":[{"name":"fileName","type":"string"}],"name":"deleteEvidence","outputs":[{"name":"code","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getFileList","outputs":[{"name":"","type":"string[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"fileName","type":"string"},{"name":"author","type":"string"},{"name":"fileHash","type":"string"},{"name":"time","type":"string"}],"name":"saveEvidence","outputs":[{"name":"code","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"fileName","type":"string"}],"name":"getEvidence","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"name":"fileHash","type":"string"},{"indexed":false,"name":"author","type":"string"},{"indexed":false,"name":"fileName","type":"string"},{"indexed":false,"name":"time","type":"string"}],"name":"UpdateInfo","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"fileName","type":"string"}],"name":"DeleteInfo","type":"event"}]
```
2. bytecode
``` 
bytecode="0x60806040526000805534801561001457600080fd5b50610e1f806100246000396000f300608060405260043610610062576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806325e6ae45146100675780634cedee48146100a457806367f245cf146100cf578063b16c6ee71461010c575b600080fd5b34801561007357600080fd5b5061008e60048036036100899190810190610894565b610149565b60405161009b9190610cd9565b60405180910390f35b3480156100b057600080fd5b506100b961027f565b6040516100c69190610b94565b60405180910390f35b3480156100db57600080fd5b506100f660048036036100f191908101906108d5565b610368565b6040516101039190610cd9565b60405180910390f35b34801561011857600080fd5b50610133600480360361012e9190810190610894565b61063b565b6040516101409190610bb6565b60405180910390f35b6000808251111515610190576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161018790610c99565b60405180910390fd5b6001826040518082805190602001908083835b6020831015156101c857805182526020820191506020810190506020830392506101a3565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206000808201600061020c9190610751565b60018201600061021c9190610751565b60028201600061022c9190610751565b60038201600061023c9190610751565b50507ffe517ba33a50b39c78ab47c67cd376e9977cde02de5e9175365177fb9a6a2b1f8260405161026d9190610bb6565b60405180910390a16000549050919050565b60606002805480602002602001604051908101604052809291908181526020016000905b8282101561035f578382906000526020600020018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561034b5780601f106103205761010080835404028352916020019161034b565b820191906000526020600020905b81548152906001019060200180831161032e57829003601f168201915b5050505050815260200190600101906102a3565b50505050905090565b600080600084511115156103b1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103a890610c79565b60405180910390fd5b600085511115156103f7576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103ee90610c59565b60405180910390fd5b6000865111151561043d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161043490610c99565b60405180910390fd5b60008351111515610483576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161047a90610c39565b60405180910390fd5b6001866040518082805190602001908083835b6020831015156104bb5780518252602082019150602081019050602083039250610496565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020905060008160030180546001816001161561010002031660029004905014151561054d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161054490610cb9565b60405180910390fd5b83816000019080519060200190610565929190610799565b508481600101908051906020019061057e929190610799565b5082816002019080519060200190610597929190610799565b50858160030190805190602001906105b0929190610799565b5060028690806001815401808255809150509060018203906000526020600020016000909192909190915090805190602001906105ee929190610799565b50507f91e662be3d45a2d3a20dd5206f0fe02f7360bd6f05ef2c536d8f3eea020a7d34848688866040516106259493929190610bd8565b60405180910390a1600054915050949350505050565b606060006001836040518082805190602001908083835b6020831015156106775780518252602082019150602081019050602083039250610652565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390209050806000018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156107445780601f1061071957610100808354040283529160200191610744565b820191906000526020600020905b81548152906001019060200180831161072757829003601f168201915b5050505050915050919050565b50805460018160011615610100020316600290046000825580601f106107775750610796565b601f0160209004906000526020600020908101906107959190610819565b5b50565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106107da57805160ff1916838001178555610808565b82800160010185558215610808579182015b828111156108075782518255916020019190600101906107ec565b5b5090506108159190610819565b5090565b61083b91905b8082111561083757600081600090555060010161081f565b5090565b90565b600082601f830112151561085157600080fd5b813561086461085f82610d21565b610cf4565b9150808252602083016020830185838301111561088057600080fd5b61088b838284610d92565b50505092915050565b6000602082840312156108a657600080fd5b600082013567ffffffffffffffff8111156108c057600080fd5b6108cc8482850161083e565b91505092915050565b600080600080608085870312156108eb57600080fd5b600085013567ffffffffffffffff81111561090557600080fd5b6109118782880161083e565b945050602085013567ffffffffffffffff81111561092e57600080fd5b61093a8782880161083e565b935050604085013567ffffffffffffffff81111561095757600080fd5b6109638782880161083e565b925050606085013567ffffffffffffffff81111561098057600080fd5b61098c8782880161083e565b91505092959194509250565b60006109a382610d5a565b808452602084019350836020820285016109bc85610d4d565b60005b848110156109f55783830388526109d7838351610a3c565b92506109e282610d7b565b91506020880197506001810190506109bf565b508196508694505050505092915050565b6000610a1182610d70565b808452610a25816020860160208601610da1565b610a2e81610dd4565b602085010191505092915050565b6000610a4782610d65565b808452610a5b816020860160208601610da1565b610a6481610dd4565b602085010191505092915050565b6000601482527f54696d652063616e6e6f7420626520656d7074790000000000000000000000006020830152604082019050919050565b6000601682527f417574686f722063616e6e6f7420626520656d707479000000000000000000006020830152604082019050919050565b6000601982527f46696c6520686173682063616e6e6f7420626520656d707479000000000000006020830152604082019050919050565b6000601982527f46696c65206e616d652063616e6e6f7420626520656d707479000000000000006020830152604082019050919050565b6000601382527f46696c6520616c726561647920657869737473000000000000000000000000006020830152604082019050919050565b610b8e81610d88565b82525050565b60006020820190508181036000830152610bae8184610998565b905092915050565b60006020820190508181036000830152610bd08184610a06565b905092915050565b60006080820190508181036000830152610bf28187610a06565b90508181036020830152610c068186610a06565b90508181036040830152610c1a8185610a06565b90508181036060830152610c2e8184610a06565b905095945050505050565b60006020820190508181036000830152610c5281610a72565b9050919050565b60006020820190508181036000830152610c7281610aa9565b9050919050565b60006020820190508181036000830152610c9281610ae0565b9050919050565b60006020820190508181036000830152610cb281610b17565b9050919050565b60006020820190508181036000830152610cd281610b4e565b9050919050565b6000602082019050610cee6000830184610b85565b92915050565b6000604051905081810181811067ffffffffffffffff82111715610d1757600080fd5b8060405250919050565b600067ffffffffffffffff821115610d3857600080fd5b601f19601f8301169050602081019050919050565b6000602082019050919050565b600081519050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b6000819050919050565b82818337600083830152505050565b60005b83811015610dbf578082015181840152602081019050610da4565b83811115610dce576000848401525b50505050565b6000601f19601f83011690509190505600a265627a7a723058202bba9ccf2ba7c505cae146d572df2bfd3d1b85e8c682580de7b1e3f6ecce2ba86c6578706572696d656e74616cf50037"
```
2. 调用abi
``` 
contract=eth.contract(abi)
```

4. 预估gas
``` 
eth.estimateGas({data: bytecode})
```
4. 初始化
``` 
initParam={from: eth.accounts[1], data: bytecode, gas: 1200000}
```
2. 部署合约
``` 
contractInstance=contract.new(initParam)
```
2. 查看合约地址
``` 
eth.getTransactionReceipt("0xf229c1b0045ffd033932cbff0b955e9b19d3ae3b9ba2950ee0a75e35a05f17eb").contractAddress
```
2. 获取私钥

``` 
var keythereum = require("keythereum");
var datadir = "dir";
var address= "0xf05ab61c38e1ee5e577c5df89d7db9c70c7c7b03";
const password = "123";
var keyObject = keythereum.importFromFile(address, datadir);
var privateKey = keythereum.recover(password, keyObject);
console.log(privateKey.toString('hex'));
```

``` 
var keythereum = require("keythereum");
var datadir = "project/dir";  // Geth 数据目录路径
var address = "0xf408d4c72339f76e1476052d43fbeba6a5a9aa43";  // 账户地址
var password = "";  // 设置为空字符串

var keyObject = keythereum.importFromFile(address, datadir);
var privateKey = keythereum.recover(password, keyObject);
console.log(privateKey.toString('hex'));
```
使用idea调制项目的话直接运行ShiroSpringbootApplication.java即可
